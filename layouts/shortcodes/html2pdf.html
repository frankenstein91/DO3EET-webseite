<script src="/js/html2canvas.min.js"></script>
<script src="/js/jspdf.umd.min.js"></script>

<style>
    .pdf-button {
        background-color: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 10px 20px;
        font-family: monospace;
        cursor: pointer;
    }
</style>

<template id="pdf-template-{{ .Inner | md5 }}">
    <div style="padding: 20px; background-color: #fff; color: #000;">
        {{ .Inner | markdownify }}
    </div>
</template>

<div id="pdf-content-{{ .Inner | md5 }}" style="position: absolute; left: -9999px;"></div>

<div style="margin-top: 20px;">
    <label for="callsign-{{ .Inner | md5 }}">Rufzeichen:</label>
    <input type="text" id="callsign-{{ .Inner | md5 }}" name="callsign" style="font-family: monospace; background-color: #000; color: #0f0; border: 1px solid #0f0;">
    <button id="generate-pdf-{{ .Inner | md5 }}" class="pdf-button">PDF generieren</button>
</div>

<script>
    document.getElementById('generate-pdf-{{ .Inner | md5 }}').addEventListener('click', function () {
        const { jsPDF } = window.jspdf;
        const template = document.getElementById('pdf-template-{{ .Inner | md5 }}');
        const callsign = document.getElementById('callsign-{{ .Inner | md5 }}').value;

        const contentToPrint = document.createElement('div');
        contentToPrint.style.position = 'absolute';
        contentToPrint.style.left = '-9999px';
        
        const clonedContent = template.content.cloneNode(true);
        contentToPrint.appendChild(clonedContent);
        
        const style = document.createElement('style');
        let css = '';
        for (let i = 0; i < document.styleSheets.length; i++) {
            const sheet = document.styleSheets[i];
            try {
                const rules = sheet.cssRules;
                for (let j = 0; j < rules.length; j++) {
                    css += rules[j].cssText;
                }
            } catch (e) {
                console.warn("Can't read the css rules of: " + sheet.href, e);
            }
        }
        style.appendChild(document.createTextNode(css));
        contentToPrint.insertBefore(style, contentToPrint.firstChild);

        document.body.appendChild(contentToPrint);

        // Replace placeholder
        const walker = document.createTreeWalker(contentToPrint, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while(node = walker.nextNode()) {
            node.nodeValue = node.nodeValue.replace(/{{`{{`}}CALLSIGN}}/g, callsign);
        }

        html2canvas(contentToPrint).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF();
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.output('dataurlnewwindow');
            document.body.removeChild(contentToPrint);
        });
    });
</script>
