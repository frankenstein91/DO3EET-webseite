<script src="/js/dom-to-image.min.js"></script>
<script src="/js/jspdf.umd.min.js"></script>

<style>
    .pdf-button {
        background-color: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 10px 20px;
        font-family: monospace;
        cursor: pointer;
    }
    #pdf-modal-{{ .Inner | md5 }} {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    #pdf-modal-content-{{ .Inner | md5 }} {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
</style>

<template id="pdf-template-{{ .Inner | md5 }}">
    {{ .Inner | markdownify }}
</template>

<div id="pdf-modal-{{ .Inner | md5 }}">
    <div id="pdf-modal-content-{{ .Inner | md5 }}"></div>
</div>

<div style="margin-top: 20px;">
    <label for="callsign-{{ .Inner | md5 }}">Rufzeichen:</label>
    <input type="text" id="callsign-{{ .Inner | md5 }}" name="callsign" style="font-family: monospace; background-color: #000; color: #0f0; border: 1px solid #0f0;">
    <button id="generate-pdf-{{ .Inner | md5 }}" class="pdf-button">PDF generieren</button>
</div>

<script>
    document.getElementById('generate-pdf-{{ .Inner | md5 }}').addEventListener('click', function () {
        const { jsPDF } = window.jspdf;
        const template = document.getElementById('pdf-template-{{ .Inner | md5 }}');
        const callsign = document.getElementById('callsign-{{ .Inner | md5 }}').value;
        const modal = document.getElementById('pdf-modal-{{ .Inner | md5 }}');
        const modalContent = document.getElementById('pdf-modal-content-{{ .Inner | md5 }}');

        const clonedContent = template.content.cloneNode(true);
        modalContent.innerHTML = '';
        modalContent.appendChild(clonedContent);

        // Replace placeholder
        const walker = document.createTreeWalker(modalContent, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while(node = walker.nextNode()) {
            node.nodeValue = node.nodeValue.replace(/{{`{{`}}CALLSIGN}}/g, callsign);
        }
        
        modal.style.display = 'block';

        domtoimage.toPng(modalContent)
            .then(function (dataUrl) {
                const pdf = new jsPDF();
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const img = new Image();
                img.src = dataUrl;
                img.onload = function() {
                    const pdfHeight = (img.height * pdfWidth) / img.width;
                    pdf.addImage(dataUrl, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.output('dataurlnewwindow');
                    modal.style.display = 'none';
                }
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
                modal.style.display = 'none';
            });
    });
</script>
